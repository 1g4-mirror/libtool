# libtool.at -- basic libtool operation tests -*- Autotest -*-
#
#   Copyright (C) 2003-2005, 2008, 2011-2012 Free Software Foundation,
#   Inc.
#   Written by Gary V. Vaughan, 2003
#
#   This file is part of GNU Libtool.
#
# GNU Libtool is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation; either version 2 of
# the License, or (at your option) any later version.
#
# GNU Libtool is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with GNU Libtool; see the file COPYING.  If not, a copy
# can be downloaded from  http://www.gnu.org/licenses/gpl.html,
# or obtained by writing to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
####

AT_BANNER([Basic libtool operation.])


## ------------------ ##
## Check help output. ##
## ------------------ ##

AT_SETUP([check help output])

AT_CHECK([$LIBTOOL --help], [0], [stdout], [stderr])
AT_CHECK([grep '^Usage:' stdout stderr], [0], [ignore])

AT_CHECK([$LIBTOOL --mode=link --help], [0], [stdout], [stderr])
AT_CHECK([grep '^Usage:' stdout stderr], [0], [ignore])

AT_CLEANUP


## ------------------- ##
## No mode diagnostic. ##
## ------------------- ##

AT_SETUP([diagnose no mode specified])

AT_CHECK([$LIBTOOL], [1], [ignore], [stderr])
AT_CHECK([grep 'you must specify a MODE' stderr], [0], [ignore])

AT_CLEANUP


## ----------------------------------- ##
## Shell meta-characters in filenames. ##
## ----------------------------------- ##

AT_SETUP([quote shell meta-characters in filenames])

eval `$LIBTOOL --config | grep '^wl='`

# Do the torture test.
for mode in compile link install; do

  # Unfortunately, without an array data type, it is nearly impossible
  # to protect libtool from metacharacters in filenames.  So, we just
  # try metacharacters in the options it needs to pass to other programs.

  # preargs and postargs need to go through libtool unmodified.
  case $mode in
  compile)
    preargs="$CC -c"
    preflag=
    match_preflag=
    flag=-DVAR=
    postargs=foo.c
    ;;

  link)
    preargs="$CC -o hell -g -O"
    preflag=-Wl,
    match_preflag=$wl
    flag=-someflag=
    postargs=foo.o
    ;;

  install)
    preargs="install -c"
    preflag=
    match_preflag=
    flag=--something=
    postargs="hell /usr/local/bin/hell"
    ;;
  esac

  # Trivial.
  LT_AT_CHECK([$LIBTOOL -n --mode=$mode $preargs $preflag"$flag:test" $postargs],
	   [0], [stdout])
  # We must not attempt to match $preargs in the output, because libtool
  # may modify them.  For example, on Cygwin, ``libtool --mode=link gcc -o
  # foo foo.o''  becomes ``gcc -o foo.exe foo.o''.
  LT_AT_CHECK([$EGREP "$mode:.*$match_preflag$flag:test " stdout], [0], [ignore])

  # Metacharacters that should be backslashified.
  for mchar in \" \` \$ \\; do
    LT_AT_CHECK([$LIBTOOL -n --mode=$mode $preargs $preflag"$flag$mchar:test$mchar" $postargs],
	     [0], [stdout])
    LT_AT_CHECK([$EGREP "$mode:.*$match_preflag\"?$flag\\\\\\$mchar:test\\\\\\$mchar\"? " stdout], [0], [ignore])
  done

  # Metacharacters that should be double quoted, and need escaping for grep
  for mchar in "@<:@" "@:>@" "^" "*"; do

    LT_AT_CHECK([$LIBTOOL -n --mode=$mode $preargs $preflag"$flag$mchar:test$mchar" $postargs],
	     [0], [stdout])
    LT_AT_CHECK([grep "$mode:.*$match_preflag\"$flag\\$mchar:test\\$mchar\" " stdout], [0], [ignore])
  done

  # Metacharacters that should be double quoted, that are not special to grep.
  for mchar in "~" "#" "&" "(" ")" "{" "}" "|" ";" "<" ">" "?" "'" " " "	"; do

    LT_AT_CHECK([$LIBTOOL -n --mode=$mode $preargs $preflag"$flag$mchar:test$mchar" $postargs],
	     [0], [stdout])
    LT_AT_CHECK([grep "$mode:.*$match_preflag\"$flag$mchar:test$mchar\" " stdout], [0], [ignore])
  done
done

AT_CLEANUP


## -------------------------- ##
## Transform source suffices. ##
## -------------------------- ##

AT_SETUP([transform source suffices])

# Extensions taken from the ones that Automake recognizes, plus Objective C,
# and GNU Ada.  Also test that multiple dots are handled correctly.
extensions="C F S ada adb ads asm c c++ cc cpp cxx f f90 F90 f95 F95 f03 F03 for go m s sx ada.ada"
bad_names=foo.

for ext in $extensions; do
  # Try a sample compile command.
  AT_CHECK([$LIBTOOL -n --mode=compile compiler -c foo.$ext],
           [1], [ignore], [stderr])
  AT_CHECK([grep 'cannot' stderr], [1], [ignore])
done

# Make sure that invalid suffixes are not recognized.
for name in $bad_names; do
  AT_CHECK([$LIBTOOL -n --mode=compile compiler -c $name],
           [1], [ignore], [stderr])
  AT_CHECK([grep 'cannot' stderr], [0], [ignore])
done

AT_CLEANUP
