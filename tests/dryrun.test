#! /bin/sh
# dryrun.test - check whether the --dry-run mode works properly

# Test script header.
need_prefix=yes
if test -z "$srcdir"; then
  srcdir=`echo "$0" | sed 's%/[^/]*$%%'`
  test "$srcdir" = "$0" && srcdir=.
  test "${VERBOSE+set}" != "set" && VERBOSE=yes
fi
. $srcdir/defs || exit 1

if test -f ../mdemo/Makefile; then :
else
  echo "You must run mdemo-conf.test before running $0" 1>&2
  exit 77
fi

# Change to our build directory.
cd ../mdemo || exit 1

before=../tests/before
after=../tests/after
normal=../tests/libtool-normal
dry=../tests/libtool-dry
stat=

echo "= Running $make clean in ../mdemo"
$make clean || exit 1

$make main.o || exit 1

eval `$libtool --config | grep "^objdir="`

mkdir $objdir
rm -f $before $after $normal $dry
sed 's/run=/run=:/' < libtool > $dry
chmod +x $dry

echo "= Making object files in ../mdemo"
ls -l . $objdir > $before
mv libtool $normal && mv $dry libtool
$make foo1.lo foo2.lo || stat=$?
mv libtool $dry && mv $normal libtool
test -n "$stat" && exit $stat
ls -l . $objdir > $after
cmp $before $after > /dev/null || exit 1
# Now really make them
$make foo1.lo foo2.lo || exit 1

echo "= Making libraries in ../mdemo"
ls -l . $objdir > $before
mv libtool $normal && mv $dry libtool
$make foo1.la libfoo2.la || stat=$?
mv libtool $dry && mv $normal libtool
test -n "$stat" && exit $stat
ls -l . $objdir > $after
cmp $before $after > /dev/null || exit 1
# Now really make them
$make foo1.la libfoo2.la || exit 1

echo "= Making programs in ../mdemo"
ls -l . $objdir > $before
mv libtool $normal && mv $dry libtool
$make mdemo mdemo.static || stat=$?
mv libtool $dry && mv $normal libtool
test -n "$stat" && exit $stat
ls -l . $objdir > $after
cmp $before $after > /dev/null || exit 1
# Now really make them
$make mdemo mdemo.static || exit 1

echo "= Running $make install in ../mdemo"
# Libtool does not create these directories
mkdir $prefix/bin
mkdir $prefix/lib
ls -l . $objdir > $before
ls -lR $prefix >> $before
mv libtool $normal && mv $dry libtool
$make install || stat=$?
mv libtool $dry && mv $normal libtool
test -n "$stat" && exit $stat
ls -l . $objdir > $after
ls -lR $prefix >> $after
cmp $before $after > /dev/null || exit 1
# Now really run it
$make install || exit 1

echo "= Running $make uninstall in ../mdemo"
ls -l . $objdir > $before
ls -lR $prefix >> $before
# Libtool does not uninstall the programs, save them
cp $prefix/bin/mdemo mdemo.sav
cp $prefix/bin/mdemo.static mdemo.static.sav
mv libtool $normal && mv $dry libtool
$make uninstall || stat=$?
mv libtool $dry && mv $normal libtool
test -n "$stat" && exit $stat
# Restore them
mv mdemo.sav $prefix/bin/mdemo
mv mdemo.static.sav $prefix/bin/mdemo.static
ls -l . $objdir > $after
ls -lR $prefix >> $after
cmp $before $after > /dev/null || exit 1
# Now really run it
$make uninstall || exit 1

rm -f $before $after $dry

exit 0
