#! /bin/sh
# dryrun.test - check whether the --dry-run mode works properly

# Test script header.
need_prefix=yes
if test -z "$srcdir"; then
  srcdir=`echo "$0" | sed 's%/[^/]*$%%'`
  test "$srcdir" = "$0" && srcdir=.
  test "${VERBOSE+set}" != "set" && VERBOSE=yes
fi
. $srcdir/defs || exit 1

if test -f ../mdemo/Makefile; then :
else
  echo "You must run mdemo-conf.test before running $0" 1>&2
  exit 77
fi

# Change to our build directory.
cd ../mdemo || exit 1

echo "= Running $make clean in ../mdemo"
$make clean || exit 1

eval `$libtool --config | grep "^objdir="`

# create `before' and `after' in a directory deep within objdir,
# so that their creation and removal does not modify even a timestamp
# in the output of `ls -l . $objdir'
for d in $objdir $objdir/temp $objdir/temp/temp; do
  test -d $d || mkdir $d
done
before=$d/before
after=$d/after

# Create a new libtool script that will enter dry run if the environment
# variable force_dry_run is set
rm -f $objdir/libtool.new
sed 's/^run=$/run=${force_dry_run+:}/' < libtool > $objdir/libtool.new
chmod +x $objdir/libtool.new
mv libtool $objdir/libtool
mv $objdir/libtool.new libtool

# main.o is not compiled with libtool, but it depends on it, so make
# sure it is up-to-date
$make main.o || exit 1

echo "= Making object files in ../mdemo"
ls -l . $objdir > $before
force_dry_run=yes $make foo1.lo foo2.lo || exit $?
ls -l . $objdir > $after
cmp $before $after > /dev/null || exit 1
# Now really make them
$make foo1.lo foo2.lo || exit 1

echo "= Making libraries in ../mdemo"
ls -l . $objdir > $before
force_dry_run=yes $make foo1.la libfoo2.la || exit $?
ls -l . $objdir > $after
cmp $before $after > /dev/null || exit 1
# Now really make them
$make foo1.la libfoo2.la || exit 1

echo "= Making programs in ../mdemo"
ls -l . $objdir > $before
force_dry_run=yes $make mdemo mdemo.static || exit $?
ls -l . $objdir > $after
cmp $before $after > /dev/null || exit 1
# Now really make them
$make mdemo mdemo.static || exit 1

echo "= Running $make install in ../mdemo"
# Libtool does not create these directories
mkdir $prefix/bin
mkdir $prefix/lib
ls -l . $objdir > $before
ls -lR $prefix >> $before
force_dry_run=yes $make install || exit 1
ls -l . $objdir > $after
ls -lR $prefix >> $after
cmp $before $after > /dev/null || exit 1
# Now really run it
$make install || exit 1

echo "= Running $make uninstall in ../mdemo"
ls -l . $objdir > $before
ls -lR $prefix >> $before
# Libtool does not uninstall the programs, save them
cp $prefix/bin/mdemo mdemo.sav
cp $prefix/bin/mdemo.static mdemo.static.sav
force_dry_run=yes $make uninstall || exit $?
# Restore them
mv mdemo.sav $prefix/bin/mdemo
mv mdemo.static.sav $prefix/bin/mdemo.static
ls -l . $objdir > $after
ls -lR $prefix >> $after
cmp $before $after > /dev/null || exit 1
# Now really run it
$make uninstall || exit 1

rm -f $before $after libtool
mv $objdir/libtool libtool

exit 0
